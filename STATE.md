# 2026-01-28
Session & Cohort decoupling refactor fully completed (backend + UI). Sessions are global, cohort visibility managed via CohortSessionAccess join table. Registration logic enforces cohort access check after auth/session fetch. Admin UI for managing cohort session access added to CohortDetail page (SessionAccessManager component). Backfill script created at scripts/backfill-cohort-session-access.ts. All cohortId references removed from session creation, update, and UI forms. 1632 tests passing, build clean.
# 2026-01-26
Seed script run completed successfully. Test admin, coach, and client accounts created. Appointments are seeded from TeamUp data and assigned to clients and coaches. Bootcamps are now multi-week programs with attendees, not appointments. All major user flows (client booking, coach assignment, bootcamp creation) are covered and verified.
# 2026-01-26
- Appointment model now includes a `title` field. All UI and backend logic updated to support appointment titles. This enables richer event data and full TeamUp compatibility.
### Features Complete
- User management/admin flows (CRUD, bulk, delete, audit logging)
- Admin user management UI (/admin/users, /admin/users/[id]) with search, filtering, navigation, and full accessibility (ARIA labels, keyboard navigation)
- Combined calendar + credits system (backend, API, UI)
  - Daily check-in system (CoachFit baseline): CRUD, compliance, streaks, UI, stats display
    - CheckInStats UI integrated in client dashboard: streak, compliance %, total check-ins shown above check-in form
- Cohort analytics: Backend and UI for compliance, streaks, participation (admin/coach dashboard)
- Coach analytics dashboard: Attention score algorithm, member prioritization, check-in history views
- SurveyJS integration: Dynamic questionnaire rendering with open-source v2.5.6
- Invoice, Payment, and Revenue models with financial reporting
- Revenue aggregation/reporting (monthly, UK tax year, paid invoices)
- Settings pages: Admin system settings (/admin/settings) and user account settings (/settings) with full CRUD

- **Appointment Conflict Detection** (Batch 4, verified):
  - Conflict detection for both create and update operations
  - Uses overlap algorithm: `aStart < bEnd && aEnd > bStart`
  - Prevents double-booking per member
- **Bootcamp Capacity Enforcement** (Batch 4, verified):
  - Capacity check on attendee registration
  - Credit consumption (decrement) and refund (increment) logic
- **HealthKit Auto-Entry** (Batch 4):
  - Auto-populates steps, calories, sleep quality from HealthKit data
  - Derives steps from walking/running workouts
  - Derives sleep quality from SleepRecord total hours
  - Tracks data sources in `dataSources` JSON field
  - UI preview shows available HealthKit data before form submission
- **Client Appointment Detail Page** (Batch 4):
  - `/appointments/me/[id]` - Client-facing appointment details
  - Shows date, time, duration, status, coach notes
  - Cancel button with 24-hour restriction
  - AlertDialog confirmation for cancellation
  - Calendar view appointments link to detail page
- **Reports Dashboard** (Phase 11):
  - Multi-domain reports: Members, Cohorts, Revenue (admin), Compliance
  - Dashboard overview with growth metrics and trend indicators
  - Role-based access: Admin sees all data, Coach sees cohort-filtered data
  - Export capabilities: CSV and JSON for all report types
  - Recharts visualizations: Area charts, pie charts, bar charts
  - UI at `/reports` with tabbed navigation
- **Coach Notes & Review Queue** (Phase 12):
  - WeeklyCoachResponse model for storing coach feedback per client per week
  - Review queue dashboard at `/coach/review-queue`
  - Week navigation with previous/next/current
  - Priority filtering (red/amber/green) based on attention scores
  - Cohort filtering for multi-cohort coaches
  - Expandable review panels with weekly stats and feedback form
  - Loom URL and note input with save functionality
  - Email draft generation with copy-to-clipboard

- **Questionnaire Builder Admin UI** (Batch 2):
  - Admin questionnaire management at `/admin/questionnaires`
  - Create/edit questionnaire bundles with visual builder
  - Drag/drop question reordering (up/down buttons)
  - Question types: Long text, Number, HTML intro
  - Required field toggles, min/max validation for numbers
  - Rich text editing with TipTap editor
  - Week-based navigation for multi-week questionnaires
- **Custom Check-In Config UI** (Batch 2):
  - Check-in settings editor integrated into cohort detail page
  - Toggle mandatory/optional prompts per cohort
  - Custom prompt support with configurable response types (scale/number/text)
  - Settings persisted in CohortCheckInConfig model
- **HealthKit API Routes** (Batch 2):
  - Pairing code system for iOS app connection
  - `/api/healthkit/pair` - iOS device pairing endpoint
  - `/api/healthkit/workouts` - Workout data ingestion
  - `/api/healthkit/sleep` - Sleep record ingestion
  - `/api/healthkit/steps` - Step count ingestion (updates Entry model)
  - Admin HealthKit dashboard at `/admin/healthkit`
  - Pairing code generator and management UI
  - HealthKit data explorer component
  - PairingCode model added to schema

- **Email System Integration** (Batch 3):
  - Email notifications integrated into all major server actions
  - Appointments: Confirmation on create, cancellation on delete
  - Invoices: Notification on send, confirmation on payment
  - Cohorts: Invitation email when member added
  - Review Queue: Coach note received notification to clients
  - Supports test user email suppression, graceful degradation without API key
- **Navigation Updates** (Batch 3):
  - Fixed 5 missing navigation links in Sidebar and MobileNav
  - Admin: Questionnaires, HealthKit, Settings, Reports
  - Coach: Review Queue, Reports
- **Credit Management System** (Batch 3):
  - CreditTransaction model for transaction history
  - Server actions: allocateCredits, getCreditsHistory, getCreditsSummary
  - UI components: CreditAllocationForm, CreditBalanceWidget, CreditHistoryTable
  - Integrated into user detail page (/admin/users/[id])
  - Supports add/deduct with reason tracking and expiry dates
- **Error and Loading States** (Batch 3):
  - Global error boundary with retry and dashboard links
  - Global loading skeleton with shadcn Skeleton component
  - Route-specific loading: appointments, cohorts, reports, admin/users

- **Comprehensive Testing Suite**:
  - **Test Infrastructure**: Mock system for Prisma, Auth, Google Calendar, Email, Stripe
  - **Test Utilities**: Factory functions for test data, helper functions (mockDate, flushPromises, waitFor)
  - **Server Action Tests**: appointments (23), cohorts (32), invoices (27), review-queue (21)
  - **Library Tests**: calendar utilities (39), utils (9)
  - **Component Tests**: Button (25), Card (23), ErrorBoundary (14)
  - **Hook Tests**: useAppointments (13)
  - **E2E Tests**: Playwright tests for auth, appointments, cohorts, invoices, review-queue
  - **Total**: 237 passing tests across 11 test files

- **Entry Deletion** (Audit Fix):
  - Server action: `deleteEntry(entryId)` with ownership verification
  - React Query hook: `useDeleteEntry()` with cache invalidation
  - Only entry owner can delete their own entries

### Features Next Up (from Cross-Platform Audit 2026-01-27)

**Critical Gaps (HIGH Priority):**
- Password reset flow with email token (PTP has it, Centurion missing)
- User goals/targets model (target weight, calories, macros, steps, workout mins) - from CoachFit
- User preferences (weight unit lbs/kg, date format) - from CoachFit
- Extended system settings (calorie limits, macro defaults, body fat categories, step categories, protein ranges) - from CoachFit
- Email template admin editor with DB storage, CRUD UI, and preview - from CoachFit
- GDPR compliance: account deletion + data export - from CoachFit
- Consent management (terms, privacy, DPA, marketing opt-in) - from CoachFit
- Cohort types enum (TIMED/ONGOING/CHALLENGE/CUSTOM) + admin-created custom types - from CoachFit
- Check-in frequency 3-level override (global → cohort → user) - from CoachFit

**Medium Gaps:**
- Workout CRUD (standalone exercise tracking) - from PTP
- Billing email field (separate from login email) - from PTP
- Body fat percentage in entries - from CoachFit
- Fitness Wrapped / Year-in-Review - from CoachFit
- ~~Role switcher for multi-role users - from CoachFit~~ **DONE**
- Apple OAuth provider - from CoachFit
- BMI calculation + unit conversions - from CoachFit

**Existing TODOs:**
- Database migration for CreditTransaction and isTestUser fields
- Cron job for weekly review queue reminders
## Project Summary
- Unified fitness platform combining Personal Trainer Planner (appointments, bootcamps, invoicing) and CoachFit (cohorts, health data).
- **Phase 7 (Daily Check-In System) and Phase 8 (Weekly Questionnaires) complete**. Ready for Phase 9: Health Data Tracking.
- Interval timer PWA (standalone `/timer`) implementation complete.

## What’s Implemented
- Member management aligned to spec naming (members, not clients): list, detail, create/edit/delete.
- (Copilot) Admin user management now supports user deletion (single and bulk), bulk actions (delete, role change), and audit logging for all admin actions.
- Appointment scheduling backbone:
  - Server actions with conflict detection and Google Calendar sync.
  - React Query hooks for create/update/delete/sync.
  - Calendar utilities for date filters and repeating dates.
- Appointments UI:
  - Create form + list view at `/appointments`.
  - Calendar view (month + week) with event cards.
  - Calendar selection pre-fills appointment date and repeat weekdays.
  - Detail/edit view at `/appointments/[id]` with status updates, inline edits, sync/delete actions.
  - Inline success/error feedback for create/update/sync/delete.
- Bootcamp system (Phase 4 ✅):
  - CRUD actions and attendee management with capacity checks.
  - Bootcamp hooks and pages.
  - Bootcamp calendar (month/week), list view, create form, and detail attendee management.
  - Capacity warnings in coach UI (at-capacity alerts, spot count indicators).
  - Client registration flow: `/client/bootcamps` page with browse/register/unregister functionality.
- Cohort system (Phase 5 ✅):
  - CRUD actions for cohorts with validation (name uniqueness, date validation).
  - Multi-coach assignment per cohort.
  - Member management with status tracking (ACTIVE/PAUSED/INACTIVE).
  - Status transitions (ACTIVE → COMPLETED → ARCHIVED).
  - Cohort list with status filtering.
  - Cohort detail page with inline editing for name, description, dates.
  - Coach assignment UI with add/remove functionality.
  - Member management UI with status changes and timestamps.
- Daily Check-In System (Phase 7 ✅):
  - Entry actions: getEntries, getEntryByDate, upsertEntry (following CoachFit patterns).
  - Check-in config actions: getCheckInConfig, updateCheckInConfig (cohort-specific prompts).
  - Check-in stats: getCheckInStats (streak calculation, compliance tracking).
  - React Query hooks for entries with cache invalidation.
  - CheckInForm component with weight, steps, calories, sleep quality, perceived stress, notes.
  - CheckInHistory component with table view of past entries.
  - Member check-in page at `/client/health` with form and history.
  - Upsert pattern for one entry per user per day (userId_date unique constraint).
- Weekly Questionnaires (Phase 8 ✅):
  - Questionnaire bundle actions: getQuestionnaireBundle, getQuestionnaireBundles, createQuestionnaireBundle, updateQuestionnaireBundle.
  - Response actions: getQuestionnaireResponse, upsertQuestionnaireResponse, getWeeklyResponses, getAllQuestionnaires.
  - Week-based access control (current week calculation from cohort startDate).
  - Status locking: IN_PROGRESS → COMPLETED (cannot edit after submission).
  - Week locking: cannot access future weeks, cannot edit past weeks.
  - React Query hooks for questionnaires with cache invalidation.
  - SurveyJS integration: Dynamic questionnaire rendering with custom theme, read-only mode, auto-save detection.
  - SurveyContainer component: Wrapper for SurveyJS Model with event handling and theme application.
  - QuestionnaireViewer component: Full survey rendering with save/submit functionality.
  - QuestionnaireResponseList component for coaches to view all responses.
  - WeeklyQuestionnaireReport component: Completion tracking across cohorts.
  - Member questionnaire page at `/client/questionnaires/[cohortId]/[weekNumber]` with live survey rendering.
  - CoachFit baseline templates (6 weeks) integrated and ready for use.
- Invoicing & Payments (Phase 6 ✅):
  - Extended Invoice model with payment tracking (paymentStatus, stripePaymentUrl, paidAt).
  - PaymentStatus enum (UNPAID, PAID, OVERDUE, CANCELLED).
  - Stripe integration library with payment link creation and webhook verification.
  - Invoice actions: auto-generate from ATTENDED appointments, manual creation, CRUD operations, payment link creation, revenue stats.
  - Invoice hooks with React Query for data fetching and mutations.
  - Invoice UI: list with status filtering, generate dialog, detail with inline status updates.
  - Revenue chart showing monthly revenue with year selector (Recharts).
  - Stripe webhook endpoint at `/api/webhooks/stripe` for payment event handling.
  - Billing pages at `/billing` and `/billing/[id]` (admin-only access).
- Coach Analytics & Insights (Phase 10 ✅):
  - Attention score algorithm: Check-ins (40%), Questionnaires (30%), Sentiment (30%), score 0-100.
  - CoachDashboard component: Member prioritization, summary statistics, drill-down to details.
  - AttentionScoreCard component: Visual score display with color-coded priorities (red/amber/green).
  - MemberCheckInList component: Detailed check-in history with stress highlighting.
  - WeeklyQuestionnaireReport component: Completion tracking and status badges.
  - React Query hooks with 5-minute stale time and 10-minute auto-refresh.
  - Server actions: calculateAttentionScore, getCoachInsights, getMemberCheckInData, getCoachCohortMembers.
  - Admin-aware data scoping: admin sees all active cohorts, coach sees only assigned cohorts.
  - Integrated into /dashboard page (CoachDashboard shown for both admin and coach roles).
- **Role Switcher** (from CoachFit):
  - ViewModeContext: Client-side React Context with localStorage persistence (`centurion-view-mode` key)
  - ViewModeSwitcher: Select dropdown in sidebar/mobile nav (Admin View / Coach View)
  - Only visible for ADMIN users — COACH and CLIENT users see no switcher
  - Switches navigation items between ADMIN and COACH nav arrays
  - No schema, auth, or middleware changes — purely client-side view mode
  - Integrated into AppLayout (ViewModeProvider), Sidebar, and MobileNav
- Google Calendar integration module using service account credentials.
- Interval timer PWA (standalone):
  - `/timer` route with timer engine, presets, and UI shell.
  - Wake Lock toggle, mute toggle, and limitations guidance.
  - Service worker + manifest for installability.
  - Preset editor with step add/remove, duplicate, and save.

## Key Files
- Spec: `unified-platform-spec.md`
- Member actions: `src/app/actions/members.ts`
- Appointment actions: `src/app/actions/appointments.ts`
- Appointment hooks: `src/hooks/useAppointments.ts`
- Entry actions: `src/app/actions/entries.ts`
- Entry hooks: `src/hooks/useEntries.ts`
- Questionnaire actions: `src/app/actions/questionnaires.ts`
- Questionnaire hooks: `src/hooks/useQuestionnaires.ts`
- Appointment UI:
  - `src/app/appointments/page.tsx`
  - `src/app/appointments/[id]/page.tsx`
  - `src/features/appointments/AppointmentDashboard.tsx`
  - `src/features/appointments/AppointmentForm.tsx`
  - `src/features/appointments/AppointmentList.tsx`
  - `src/features/appointments/AppointmentCalendar.tsx`
  - `src/features/appointments/AppointmentCard.tsx`
  - `src/features/appointments/AppointmentDetail.tsx`
- Bootcamp actions: `src/app/actions/bootcamps.ts`, `src/app/actions/client-bootcamps.ts`
- Bootcamp hooks: `src/hooks/useBootcamps.ts`, `src/hooks/useClientBootcamps.ts`
- Bootcamp UI:
  - `src/app/bootcamps/page.tsx` (coach)
  - `src/app/bootcamps/[id]/page.tsx` (coach detail)
  - `src/app/client/bootcamps/page.tsx` (client registration)
  - `src/features/bootcamps/BootcampForm.tsx`
  - `src/features/bootcamps/BootcampList.tsx`
  - `src/features/bootcamps/BootcampCalendar.tsx`
  - `src/features/bootcamps/BootcampDetail.tsx` (with capacity warnings)
  - `src/features/bootcamps/BootcampRegistration.tsx` (client view)
- Cohort actions: `src/app/actions/cohorts.ts`
- Cohort hooks: `src/hooks/useCohorts.ts`, `src/hooks/useMembers.ts`
- Cohort UI:
  - `src/app/cohorts/page.tsx` (coach/admin)
  - `src/app/cohorts/[id]/page.tsx` (cohort detail)
  - `src/features/cohorts/CohortForm.tsx`
  - `src/features/cohorts/CohortList.tsx`
  - `src/features/cohorts/CohortDetail.tsx` (with inline editing)
  - `src/features/cohorts/CoachAssignment.tsx` (multi-coach management)
  - `src/features/cohorts/MemberManagement.tsx` (status tracking)
- Invoice actions: `src/app/actions/invoices.ts`
- Invoice hooks: `src/hooks/useInvoices.ts`
- Invoice UI:
  - `src/app/billing/page.tsx` (admin billing dashboard)
  - `src/app/billing/[id]/page.tsx` (invoice detail)
  - `src/features/invoices/InvoiceList.tsx` (with status filtering)
  - `src/features/invoices/GenerateInvoiceDialog.tsx`
  - `src/features/invoices/InvoiceDetail.tsx` (with payment link management)
  - `src/features/invoices/RevenueChart.tsx` (monthly revenue visualization)
- Entry UI:
  - `src/app/client/health/page.tsx` (member check-in page)
  - `src/features/entries/CheckInForm.tsx` (daily check-in form)
  - `src/features/entries/CheckInHistory.tsx` (past entries table)
- Questionnaire UI:
  - `src/app/client/questionnaires/[cohortId]/[weekNumber]/page.tsx` (member questionnaire page)
  - `src/features/questionnaires/QuestionnaireViewer.tsx` (questionnaire viewer with locking)
  - `src/features/questionnaires/QuestionnaireResponseList.tsx` (coach response view)
- Stripe integration: `src/lib/stripe.ts`
- Stripe webhook: `src/app/api/webhooks/stripe/route.ts`
- Reports actions: `src/app/actions/reports.ts`
- Reports hooks: `src/hooks/useReports.ts`
- Reports UI:
  - `src/app/reports/page.tsx` (reports dashboard)
  - `src/features/reports/ReportsDashboard.tsx` (tabbed interface)
  - `src/features/reports/OverviewCards.tsx` (summary metrics)
  - `src/features/reports/MemberEngagementChart.tsx` (check-in trends)
  - `src/features/reports/CohortAnalytics.tsx` (cohort performance)
  - `src/features/reports/RevenueAnalytics.tsx` (revenue charts)
  - `src/features/reports/ComplianceReport.tsx` (questionnaire completion)
  - `src/features/reports/ExportButton.tsx` (CSV/JSON export)
- Review Queue actions: `src/app/actions/review-queue.ts`
- Review Queue hooks: `src/hooks/useReviewQueue.ts`
- Review Queue UI:
  - `src/app/coach/review-queue/page.tsx` (review queue page)
  - `src/features/review-queue/ReviewQueueDashboard.tsx` (main dashboard)
- Email draft utility: `src/lib/email-draft.ts`
- Calendar utilities: `src/lib/calendar.ts`
- Google Calendar: `src/lib/google-calendar.ts`
- Work log: `WORKLOG.md`
- Test mocks: `src/__tests__/mocks/` (prisma, auth, google-calendar, email, stripe)
- Test utilities: `src/__tests__/utils/` (test-data, test-helpers)
- Server action tests: `src/__tests__/actions/` (appointments, cohorts, invoices, review-queue)
- Library tests: `src/__tests__/lib/` (calendar, utils)
- Component tests: `src/__tests__/components/` (button, card, ErrorBoundary)
- Hook tests: `src/__tests__/hooks/` (useAppointments)
- E2E tests: `e2e/` (auth, appointments, cohorts, invoices, review-queue)
- Client-facing pages (PTP-style):
  - `/appointments/me` (calendar)
  - `/cohorts/me` (read-only memberships)
  - `/invoices/me` and `/invoices/me/[id]` (list/detail, print, pay)
  - `/client/appointments`, `/client/cohorts`, `/client/invoices` redirect to `/.../me`
  - `/client/health` with daily check-in form and history
- `/settings` user profile settings with name, email, password management
- `/admin/settings` system settings with feature flags and configuration
- Role Switcher:
  - `src/contexts/ViewModeContext.tsx` (context + provider + useViewMode hook)
  - `src/components/layouts/ViewModeSwitcher.tsx` (UI dropdown)
- Timer PWA:
  - `src/app/timer/page.tsx`
  - `src/app/timer/TimerSwRegister.tsx`
  - `src/app/timer/limitations.tsx`
  - `src/features/timer/TimerShell.tsx`
  - `src/features/timer/TimerEditor.tsx`
  - `src/features/timer/TimerPresetImportExport.tsx`
  - `src/features/appointments/ClientAppointmentsCalendar.tsx`
  - `src/app/appointments/me/page.tsx`
  - `src/app/cohorts/me/page.tsx`
  - `src/app/invoices/me/page.tsx`
  - `src/app/invoices/me/[id]/page.tsx`
  - `src/app/client/appointments/page.tsx`
  - `src/app/client/cohorts/page.tsx`
  - `src/app/client/invoices/page.tsx`
  - `src/app/actions/client-appointments.ts`
  - `src/app/actions/client-cohorts.ts`
  - `src/app/actions/client-invoices.ts`
  - `src/hooks/useClientAppointments.ts`
  - `src/hooks/useClientCohorts.ts`
  - `src/hooks/useClientInvoices.ts`
  - `src/features/timer/useIntervalTimer.ts`
  - `src/features/timer/presets.ts`
  - `src/features/timer/types.ts`
  - `public/manifest.json`
  - `public/timer-sw.js`
  - `public/timer-icon-192.png`, `public/timer-icon-512.png`

## Data Model Notes
- Prisma Appointment model uses `startTime`, `endTime`, `fee`, `status`, optional `googleEventId`, `invoiceId`.
- Conflict checks enforced on create and update for overlapping sessions per member.
- Bootcamp attendee capacity enforced when adding attendees.
- Cohort model with `status` (ACTIVE/COMPLETED/ARCHIVED), optional `endDate`, multi-coach support.
- CohortMembership tracks member status (ACTIVE/PAUSED/INACTIVE) with `joinedAt`/`leftAt` timestamps.
- Invoice model with `paymentStatus` (UNPAID/PAID/OVERDUE/CANCELLED), `stripePaymentUrl`, `paidAt` timestamp.
- Invoices auto-generate from ATTENDED appointments, linking appointments via `invoiceId`.
- Entry model with `userId_date` unique constraint (one entry per user per day), JSON fields for `customResponses` and `dataSources`.
- QuestionnaireBundle model with `cohortId_weekNumber` unique constraint, `questions` JSON field for SurveyJS format.
- WeeklyQuestionnaireResponse model with `userId_bundleId` unique constraint, `responses` JSON, `status` enum (IN_PROGRESS/COMPLETED).
- CohortCheckInConfig model with `cohortId` unique, `prompts` JSON field for custom check-in prompts.

## Environment / Dependencies
- `google-auth-library` + `googleapis` for Calendar sync (lockfile updated).
- `stripe` for payment processing and webhook handling.
- `recharts` for revenue data visualization.
- React Query provider registered in `src/app/layout.tsx` via `src/app/providers.tsx`.
- Environment variables: `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET` (for production deployments).

## Cross-Platform Audit (2026-01-27)
- **~65 features implemented** from CoachFit + PTP
- **~10 features where Centurion exceeds** source apps
- **~23 feature gaps** identified (9 critical, 8 medium, 6 low)
- Full audit details in WORKLOG.md entry for 2026-01-27

## Open TODOs
- Consider adding global toast notifications for feedback (currently inline messages).
- Run database migration for CreditTransaction and isTestUser fields (`npx prisma migrate dev`).
- Add cron job for weekly review queue reminder notifications.
- Consider adding print/PDF export for reports.
- iOS app development for HealthKit sync.
- Address 9 critical gaps from cross-platform audit (see Features Next Up).

## How to Run
- `npm run dev` - Start development server
- `npm run test` - Run all unit/component tests
- `npm run test:watch` - Run tests in watch mode
- `npm run test:ui` - Run tests with Vitest UI
- `npm run test:e2e` - Run Playwright E2E tests
- `npm run test:e2e:ui` - Run E2E tests with Playwright UI

## Recent Commits
- `refactor: align members naming and routes`
- `feat: start appointments scheduling backbone`
- `feat: add appointments calendar and detail view`
- `chore: update lockfile after deps install`
- `feat: wire calendar selection and feedback`
