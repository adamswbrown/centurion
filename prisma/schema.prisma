// Centurion Unified Fitness Platform - Database Schema
// Combines Personal Trainer Planner + CoachFit functionality
// Production-ready schema with proper indexing, constraints, and relationships

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & USERS
// ============================================

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  billingEmail  String?   // Separate billing email (M2)
  password      String?   // Nullable for OAuth-only users
  name          String?
  image         String?
  emailVerified Boolean   @default(false)
  role          Role      @default(CLIENT)
  credits       Int       @default(0)
  creditsExpiry DateTime? // Optional: when credits expire
  isTestUser    Boolean   @default(false) // Suppress emails for test users

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Personal Training Relations
  appointmentsAsClient Appointment[] @relation("AppointmentUser")
  appointmentsAsCoach  Appointment[] @relation("AppointmentCoach")
  bootcampAttendees  BootcampAttendee[]
  workouts           Workout[]
  invoices           Invoice[]

  // Health Coaching Relations
  cohortMemberships  CohortMembership[]
  coachCohorts       CoachCohortMembership[]  @relation("CoachCohorts")
  entries            Entry[]
  questionnaireResponses WeeklyQuestionnaireResponse[]
  coachNotesWritten  CoachNote[]              @relation("CoachNotes")
  coachNotesReceived CoachNote[]              @relation("ClientNotes")
  weeklyResponsesAsClient  WeeklyCoachResponse[] @relation("ClientWeeklyResponses")
  weeklyResponsesAsCoach   WeeklyCoachResponse[] @relation("CoachWeeklyResponses")

  // HealthKit Relations
  healthKitWorkouts  HealthKitWorkout[]
  sleepRecords       SleepRecord[]
  pairingCodesAsUser PairingCode[]       @relation("PairingCodeUser")
  pairingCodesCreated PairingCode[]      @relation("PairingCodeCreator")

  // Credit Management Relations
  creditTransactionsReceived CreditTransaction[] @relation("CreditTransactionsReceived")
  creditTransactionsCreated  CreditTransaction[] @relation("CreditTransactionsCreated")

  // OAuth Relations
  accounts      Account[]
  sessions      Session[]

  // Legal & Consent
  consent        UserConsent?

  // User Personalization
  goals              UserGoals?
  preferences        UserPreference?
  checkInFrequencyDays Int?  // Override cohort and system default

  // Cohort Types (Phase 3 - C8)
  customCohortTypes  CustomCohortType[]

  @@map("users")
  @@index([email])
  @@index([role])
  @@index([credits])
  @@index([createdAt])
}

enum Role {
  ADMIN
  COACH
  CLIENT
}

// NextAuth Models
model Account {
  id                Int     @id @default(autoincrement())
  userId            Int
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
  @@index([userId])
}

model Session {
  id           Int      @id @default(autoincrement())
  sessionToken String   @unique
  userId       Int
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
  @@index([userId])
  @@index([sessionToken])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// LEGAL & CONSENT
// ============================================

model UserConsent {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique
  termsAccepted   DateTime
  privacyAccepted DateTime
  dataProcessing  DateTime
  marketing       DateTime? // Optional marketing opt-in
  version         String    // e.g. "1.0.0" - tracks which version of terms
  ipAddress       String?
  userAgent       String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_consents")
  @@index([userId])
  @@index([createdAt])
}

// ============================================
// PERSONAL TRAINING (From Personal Trainer Planner)
// ============================================

model Appointment {
  id            Int              @id @default(autoincrement())
  userId        Int
  coachId       Int
  startTime     DateTime
  endTime       DateTime
  fee           Decimal          @db.Decimal(10, 2)
  status        AttendanceStatus @default(NOT_ATTENDED)
  notes         String?
  videoUrl      String?          // Optional video call URL
  googleEventId String?          // For calendar sync
  invoiceId     Int?
  title         String?

  user    User     @relation("AppointmentUser", fields: [userId], references: [id], onDelete: Cascade)
  coach   User     @relation("AppointmentCoach", fields: [coachId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("appointments")
  @@index([userId])
  @@index([coachId])
  @@index([startTime])
  @@index([userId, startTime])
  @@index([invoiceId])
  @@index([status])
}

enum AttendanceStatus {
  ATTENDED
  NOT_ATTENDED
}

model Bootcamp {
  id          Int      @id @default(autoincrement())
  name        String
  startTime   DateTime
  endTime     DateTime
  location    String?
  capacity    Int?
  description String?

  attendees  BootcampAttendee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bootcamps")
  @@index([startTime])
  @@index([name])
}

model BootcampAttendee {
  id         Int      @id @default(autoincrement())
  bootcampId Int
  userId     Int

  bootcamp   Bootcamp @relation(fields: [bootcampId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([bootcampId, userId])
  @@map("bootcamp_attendees")
  @@index([bootcampId])
  @@index([userId])
}

model Workout {
  id          Int           @id @default(autoincrement())
  userId      Int
  coachId     Int?          // Coach who assigned the workout (M1)
  title       String
  description String?
  videoUrl    String?       // Instructional video link (M1)
  status      WorkoutStatus @default(NOT_STARTED)
  scheduledAt DateTime?     // When the workout is scheduled for (M1)
  completedAt DateTime?     // When the workout was completed (M1)
  duration    Int?          // Duration in minutes (M1)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workouts")
  @@index([userId])
  @@index([coachId])
  @@index([status])
  @@index([scheduledAt])
}

enum WorkoutStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model Invoice {
  id               Int           @id @default(autoincrement())
  userId           Int
  month            DateTime      @db.Date
  totalAmount      Decimal       @db.Decimal(10, 2)
  emailSent        Boolean       @default(false)
  emailSentAt      DateTime?
  paymentStatus    PaymentStatus @default(UNPAID)
  stripePaymentUrl String?
  paidAt           DateTime?

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invoices")
  @@index([userId])
  @@index([month])
  @@index([userId, month])
  @@index([emailSent])
  @@index([paymentStatus])
}

enum PaymentStatus {
  UNPAID
  PAID
  OVERDUE
  CANCELLED
}

// ============================================
// HEALTH COACHING (From CoachFit)
// ============================================

model Cohort {
  id          Int          @id @default(autoincrement())
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime?
  status      CohortStatus @default(ACTIVE)

  checkInFrequencyDays Int?  // Override system default

  // Cohort type (Phase 3 - C8)
  type                   CohortType?
  customCohortTypeId     Int?
  customCohortType       CustomCohortType? @relation(fields: [customCohortTypeId], references: [id], onDelete: Restrict)
  membershipDurationMonths Int?   // For ONGOING type cohorts

  coaches     CoachCohortMembership[]
  members     CohortMembership[]
  bundles     QuestionnaireBundle[]
  config      CohortCheckInConfig?
  insights    AdminInsight[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("cohorts")
  @@index([status])
  @@index([startDate])
  @@index([status, startDate])
  @@index([name])
  @@index([type])
  @@index([customCohortTypeId])
}

enum CohortStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

model CohortMembership {
  id        Int              @id @default(autoincrement())
  cohortId  Int
  userId    Int
  status    MembershipStatus @default(ACTIVE)
  joinedAt  DateTime         @default(now())
  leftAt    DateTime?

  cohort Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([cohortId, userId])
  @@map("cohort_memberships")
  @@index([cohortId])
  @@index([userId])
  @@index([cohortId, status])
  @@index([status])
}

enum MembershipStatus {
  ACTIVE
  PAUSED
  INACTIVE
}

model CoachCohortMembership {
  id       Int      @id @default(autoincrement())
  cohortId Int
  coachId  Int

  cohort Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  coach  User   @relation("CoachCohorts", fields: [coachId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([cohortId, coachId])
  @@map("coach_cohort_memberships")
  @@index([cohortId])
  @@index([coachId])
}

model Entry {
  id              Int      @id @default(autoincrement())
  userId          Int
  date            DateTime @db.Date

  // Health metrics
  weight          Float?
  bodyFatPercentage Float?   // Body fat % (M3)
  heightInches    Float?     // Height in inches for BMI calculation (M7)
  steps           Int?
  calories        Int?
  sleepQuality    Int?     // 1-10 scale
  perceivedStress Int?     // 1-10 scale
  notes           String?

  // Custom responses per cohort
  customResponses Json?

  // Data source tracking
  dataSources     Json?    // {"weight": "manual", "steps": "healthkit"}

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@map("entries")
  @@index([userId])
  @@index([date])
  @@index([userId, date])
}

model QuestionnaireBundle {
  id          Int      @id @default(autoincrement())
  cohortId    Int
  weekNumber  Int
  questions   Json     // SurveyJS format
  isActive    Boolean  @default(true)

  cohort    Cohort                        @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  responses WeeklyQuestionnaireResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cohortId, weekNumber])
  @@map("questionnaire_bundles")
  @@index([cohortId])
  @@index([weekNumber])
  @@index([isActive])
}

model WeeklyQuestionnaireResponse {
  id         Int            @id @default(autoincrement())
  userId     Int
  bundleId   Int
  weekNumber Int
  responses  Json           // User's answers
  status     ResponseStatus @default(IN_PROGRESS)

  user   User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  bundle QuestionnaireBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, bundleId])
  @@map("weekly_questionnaire_responses")
  @@index([userId])
  @@index([bundleId])
  @@index([weekNumber])
  @@index([status])
}

enum ResponseStatus {
  IN_PROGRESS
  COMPLETED
}

model CohortCheckInConfig {
  id       Int    @id @default(autoincrement())
  cohortId Int    @unique
  prompts  Json   // Custom check-in questions

  cohort Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cohort_check_in_configs")
}

model CoachNote {
  id         Int      @id @default(autoincrement())
  userId     Int      // Client
  coachId    Int      // Coach
  weekNumber Int
  notes      String

  user  User @relation("ClientNotes", fields: [userId], references: [id], onDelete: Cascade)
  coach User @relation("CoachNotes", fields: [coachId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("coach_notes")
  @@index([userId])
  @@index([coachId])
  @@index([userId, weekNumber])
  @@index([coachId, userId])
}

model AdminInsight {
  id          Int             @id @default(autoincrement())
  cohortId    Int?
  title       String
  description String
  priority    InsightPriority @default(MEDIUM)
  status      InsightStatus   @default(ACTIVE)

  cohort Cohort? @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_insights")
  @@index([cohortId])
  @@index([status])
  @@index([priority])
  @@index([status, priority])
}

enum InsightPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum InsightStatus {
  ACTIVE
  RESOLVED
  DISMISSED
}

// ============================================
// HEALTHKIT INTEGRATION (From CoachFit)
// ============================================

model HealthKitWorkout {
  id           Int      @id @default(autoincrement())
  userId       Int
  workoutType  String
  startTime    DateTime
  endTime      DateTime
  duration     Int      // seconds
  calories     Float?
  distance     Float?   // meters
  heartRate    Json?    // {avg: 150, max: 180}
  metadata     Json?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("healthkit_workouts")
  @@index([userId])
  @@index([startTime])
  @@index([userId, startTime])
  @@index([workoutType])
}

model SleepRecord {
  id            Int      @id @default(autoincrement())
  userId        Int
  startTime     DateTime
  endTime       DateTime
  totalSleep    Int      // minutes
  inBedTime     Int      // minutes
  deepSleep     Int?     // minutes
  remSleep      Int?     // minutes
  coreSleep     Int?     // minutes
  sourceDevice  String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("sleep_records")
  @@index([userId])
  @@index([startTime])
  @@index([userId, startTime])
}

// ============================================
// HEALTHKIT PAIRING
// ============================================

model PairingCode {
  id        Int       @id @default(autoincrement())
  code      String    @unique
  userId    Int       // The client this code is for
  createdBy Int       // Coach/admin who created the code
  expiresAt DateTime
  usedAt    DateTime?

  user      User @relation("PairingCodeUser", fields: [userId], references: [id], onDelete: Cascade)
  creator   User @relation("PairingCodeCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("pairing_codes")
  @@index([code])
  @@index([userId])
  @@index([expiresAt])
}

// ============================================
// CREDIT MANAGEMENT
// ============================================

model CreditTransaction {
  id          Int       @id @default(autoincrement())
  userId      Int
  amount      Int       // Positive for allocation, negative for deduction
  reason      String
  expiresAt   DateTime?
  createdById Int

  user      User @relation("CreditTransactionsReceived", fields: [userId], references: [id], onDelete: Cascade)
  createdBy User @relation("CreditTransactionsCreated", fields: [createdById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("credit_transactions")
  @@index([userId])
  @@index([createdById])
  @@index([createdAt])
  @@index([userId, createdAt])
}

// ============================================
// SYSTEM & ADMIN
// ============================================

model SystemSettings {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value Json

  updatedAt DateTime @updatedAt

  @@map("system_settings")
  @@index([key])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?     // Actor (null if system)
  action    String   // CREATE_COHORT, DELETE_USER, etc.
  target    String?  // Resource affected
  metadata  Json?    // Additional context

  createdAt DateTime @default(now())

  @@map("audit_logs")
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([userId, createdAt])
}

// ============================================
// WEEKLY REVIEW QUEUE (From CoachFit)
// ============================================

model WeeklyCoachResponse {
  id        Int      @id @default(autoincrement())
  coachId   Int
  clientId  Int
  weekStart DateTime @db.Date
  loomUrl   String?  // Optional video feedback URL
  note      String?  // Coach's weekly note/feedback

  coach  User @relation("CoachWeeklyResponses", fields: [coachId], references: [id], onDelete: Cascade)
  client User @relation("ClientWeeklyResponses", fields: [clientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([coachId, clientId, weekStart])
  @@map("weekly_coach_responses")
  @@index([coachId, clientId])
  @@index([weekStart])
  @@index([clientId])
}

// ============================================
// USER PERSONALIZATION
// ============================================

model UserGoals {
  id                   Int      @id @default(autoincrement())
  userId               Int      @unique
  currentWeightKg      Float?
  targetWeightKg       Float?
  heightCm             Float?
  dailyCaloriesKcal    Int?
  proteinGrams         Float?
  carbGrams            Float?
  fatGrams             Float?
  waterIntakeMl        Int?
  dailyStepsTarget     Int?
  weeklyWorkoutMinutes Int?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_goals")
  @@index([userId])
}

model UserPreference {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  weightUnit      String   @default("lbs")       // "lbs" | "kg"
  measurementUnit String   @default("inches")     // "inches" | "cm"
  dateFormat      String   @default("MM/dd/yyyy") // "MM/dd/yyyy" | "dd/MM/yyyy" | "yyyy-MM-dd"

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
  @@index([userId])
}

// ============================================
// EMAIL TEMPLATES (Phase 3 - C5)
// ============================================

model EmailTemplate {
  id              Int      @id @default(autoincrement())
  key             String   @unique        // e.g. "welcome_client"
  name            String                  // Human-readable name
  description     String?                 // What this template is for
  subjectTemplate String                  // Subject with {{tokens}}
  bodyTemplate    String   @db.Text       // HTML body with {{tokens}}
  textTemplate    String   @db.Text       // Plain text version
  availableTokens String[]               // List of valid tokens for this template
  enabled         Boolean  @default(true)
  isSystem        Boolean  @default(true) // System templates can't be deleted

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_templates")
  @@index([key])
  @@index([enabled])
}

// ============================================
// COHORT TYPES (Phase 3 - C8)
// ============================================

enum CohortType {
  TIMED
  ONGOING
  CHALLENGE
  CUSTOM
}

model CustomCohortType {
  id          Int      @id @default(autoincrement())
  label       String   @unique
  description String?
  createdBy   Int

  creator User     @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  cohorts Cohort[]

  createdAt DateTime @default(now())

  @@map("custom_cohort_types")
  @@index([createdBy])
  @@index([createdAt])
}
